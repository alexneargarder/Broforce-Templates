#!/bin/bash
# Bash completion for broforce-tools

_get_projects() {
    local mode="$1"
    python3 -m broforce_tools.completion_helper "$mode" 2>/dev/null
}

_broforce_tools_completions()
{
    local cur prev commands
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    commands="create init-thunderstore package unreleased changelog"

    # Complete subcommands
    if [ $COMP_CWORD -eq 1 ]; then
        COMPREPLY=($(compgen -W "$commands --help --clear-cache --add-repo" -- "$cur"))
        return 0
    fi

    local subcommand="${COMP_WORDS[1]}"

    case "$subcommand" in
        create)
            if [[ "$prev" == "-t" ]] || [[ "$prev" == "--type" ]]; then
                COMPREPLY=($(compgen -W "mod bro" -- "$cur"))
            elif [[ "$prev" == "-o" ]] || [[ "$prev" == "--output-repo" ]]; then
                local IFS=$'\n'
                COMPREPLY=($(compgen -W "$(_get_projects repos)" -- "$cur"))
            elif [[ "$cur" == -* ]]; then
                COMPREPLY=($(compgen -W "-t --type -n --name -a --author -o --output-repo -y --non-interactive --no-thunderstore --help" -- "$cur"))
            fi
            ;;
        init-thunderstore)
            if [[ "$cur" == -* ]]; then
                COMPREPLY=($(compgen -W "-y --non-interactive -n --namespace -d --description -w --website-url -p --package-name --all-repos --help" -- "$cur"))
            else
                compopt -o filenames 2>/dev/null
                local IFS=$'\n'
                COMPREPLY=($(compgen -W "$(_get_projects init)" -- "$cur"))
            fi
            ;;
        package)
            if [[ "$prev" == "--version" ]] || [[ "$prev" == "--package" ]]; then
                return 0
            elif [[ "$cur" == -* ]]; then
                COMPREPLY=($(compgen -W "-y --non-interactive --version --all-repos --allow-outdated-changelog --overwrite --update-deps --no-update-deps --add-missing-deps --no-add-missing-deps --help" -- "$cur"))
            else
                compopt -o filenames 2>/dev/null
                local IFS=$'\n'
                COMPREPLY=($(compgen -W "$(_get_projects package)" -- "$cur"))
            fi
            ;;
        unreleased)
            if [[ "$prev" == "--package" ]]; then
                compopt -o filenames 2>/dev/null
                local IFS=$'\n'
                COMPREPLY=($(compgen -W "$(_get_projects package)" -- "$cur"))
            elif [[ "$cur" == -* ]]; then
                COMPREPLY=($(compgen -W "-y --non-interactive --all-repos --package-all --package --help" -- "$cur"))
            fi
            ;;
        changelog)
            # Handle changelog subcommands
            if [ $COMP_CWORD -eq 2 ]; then
                COMPREPLY=($(compgen -W "add show edit --help" -- "$cur"))
            else
                local changelog_subcommand="${COMP_WORDS[2]}"
                case "$changelog_subcommand" in
                    add|show|edit)
                        if [[ "$cur" == -* ]]; then
                            COMPREPLY=($(compgen -W "-y --non-interactive --all-repos --help" -- "$cur"))
                        else
                            compopt -o filenames 2>/dev/null
                            local IFS=$'\n'
                            COMPREPLY=($(compgen -W "$(_get_projects package)" -- "$cur"))
                        fi
                        ;;
                esac
            fi
            ;;
    esac

    return 0
}

complete -F _broforce_tools_completions broforce-tools
complete -F _broforce_tools_completions bt
